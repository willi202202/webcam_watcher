
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Webcam</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #f3f3f3;
  margin: 0;
  padding: 20px;
}
h1 {
  text-align: center;
}
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 14px;
}
.card {
  background: white;
  padding: 8px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,.12);
}
.card img {
  width: 100%;
  border-radius: 10px;
}
.filename {
  font-size: .8em;
  text-align: center;
  margin-top: 5px;
  word-break: break-all;
}
</style>

<meta http-equiv="refresh" content="20">

</head>
<body>
<h1>Webcam (Chappelihof 24)</h1>
<h2>Status</h2>
<p>
  Webcam: <span id="webcam-status">prüfe…</span><br>
  Watcher Script: <span id="script-status">prüfe…</span><br>
  <a href="https://cam.roman.willi.my.to" target="_blank"
   style="display:inline-block; margin-top:10px; padding:10px 16px;
          background:#e27b7b; color:white; border-radius:8px;
          text-decoration:none;">
  Webcam-Admin öffnen
</a>
</p>
<h2>Bilder</h2>
<p style="text-align:center;color:#666;">
Aktualisiert automatisch alle 20 Sekunden.
</p>

<div id="gallery" class="grid"></div>

<script>
const imageBase = "/log/webcam/";

async function loadImages() {
  const response = await fetch(imageBase);
  const text = await response.text();

  const parser = new DOMParser();
  const doc = parser.parseFromString(text, "text/html");

  // Find all links ending with jpg/png/jpeg
  let links = Array.from(doc.querySelectorAll("a"))
    .map(a => a.getAttribute("href"))
    .filter(h => h && h.match(/\.(jpg|jpeg|png)$/i))
    .sort()
    .reverse(); // newest first (by filename sort)

  const gallery = document.getElementById("gallery");
  gallery.innerHTML = "";

  for (const file of links) {
    const card = document.createElement("div");
    card.className = "card";

    const img = document.createElement("img");
    img.src = imageBase + file + "?t=" + Date.now(); // cache busting

    const name = document.createElement("div");
    name.className = "filename";
    name.textContent = file;

    card.appendChild(img);
    card.appendChild(name);
    gallery.appendChild(card);
  }
}

loadImages();
</script>

<script>
function set(el, ok) {
  el.textContent = ok ? "ONLINE" : "OFFLINE";
  el.style.color = ok ? "green" : "red";
}

async function loadStatus() {
  try {
    const r = await fetch("/webcam/status.json?ts=" + Date.now());
    const data = await r.json();

    set(document.getElementById("webcam-status"), data.webcam_online);

    // watcher ok, wenn file frisch (< 2 min)
    const ts = new Date(data.timestamp.replace(" ", "T"));
    const age = (Date.now() - ts.getTime()) / 1000;
    set(document.getElementById("script-status"), age < 120);

  } catch (e) {
    set(document.getElementById("webcam-status"), false);
    set(document.getElementById("script-status"), false);
  }
}

loadStatus();
setInterval(loadStatus, 20000);
</script>

</body>
</html>
